{
    "build": {
        // Installs latest version from the Distribution
        "dockerfile": "./Dockerfile",
        "context": ".",
        "args": {
        "HTTP_PROXY": "${localEnv:HTTP_PROXY}",
        "HTTPS_PROXY": "${localEnv:HTTPS_PROXY}",
        "http_proxy": "${localEnv:http_proxy}",
        "https_proxy": "${localEnv:https_proxy}",
        "NO_PROXY": "${localEnv:NO_PROXY}",
        "no_proxy": "${localEnv:no_proxy}",
        "USERNAME": "${localEnv:USER}",
        "USER_ID": "${localEnv:UID}",
        "USER_GID": "${localEnv:GID}"
        }
    },
    "features": {
        "ghcr.io/devcontainers/features/common-utils": {
            // Installs latest version from the Distribution
            "installZsh": "false",
            "username": "vscode",
            "userUid": "1000",
            "userGid": "1000",
            "upgradePackages": "false" // WARNING: do *not* enable; this would include packages also from other features, which may have been pinned to a specific version
        },
        "ghcr.io/devcontainers-community/features/llvm": {
            // Full semantic version pinning does not work with this feature.
            // In case we want this, the feature needs to be replaced with a custom installation script.
            "version": "20"
        },
        "ghcr.io/devcontainers/features/rust": {
            "version": "1.83.0",
            "components": [
                "cargo",
                "clippy",
                // "miri", // only available at nightly
                "rust-analyzer",
                "rust-src",
                "rustfmt"
            ]
        },
        "./s-core-local": {}
    },
    "overrideFeatureInstallOrder": [
        // this order makes it more convenient to develop the s-core-local feature, since it will be installed last
        // which means changes to it will be applied without needing to rebuild all other features
        "ghcr.io/devcontainers/features/common-utils",
        "ghcr.io/devcontainers-community/features/llvm",
        "ghcr.io/devcontainers/features/rust",
        "./s-core-local"
    ],
    "remoteUser": "vscode",
    "customizations": {
        "vscode": {
            "extensions": [
                "usernamehw.errorlens",
                "lextudio.restructuredtext",
                "ms-python.python",
                "charliermarsh.ruff",
                "mads-hartmann.bash-ide-vscode",
                "bazelbuild.vscode-bazel", // Bazel support for Visual Studio Code; see also bazel.lsp.command below
                "dbaeumer.vscode-eslint",
                "EditorConfig.EditorConfig",
                "ms-vscode.live-server", // live preview of HTML files
                "llvm-vs-code-extensions.vscode-clangd",
                "jebbs.plantuml", // preview PlantUML diagrams
                "hediet.vscode-drawio", // Draw.IO integration
                "swyddfa.esbonio", // for Sphinx documentation support
                "rust-lang.rust-analyzer", // Rust language support for Visual Studio Code; see also tasks below
                "github.vscode-pull-request-github", // GitHub integration
                "bierner.markdown-preview-github-styles" // GitHub style for Markdown preview
            ],
            "settings": {
                "files.insertFinalNewline": true,
                "editor.formatOnSave": false,
                "[cpp]": {
                    "editor.defaultFormatter": "llvm-vs-code-extensions.vscode-clangd"
                },
                "clangd.path": "/usr/bin/clangd",
                "clangd.arguments": [
                    "--compile-commands-dir=${workspaceFolder}/",
                    "--pretty",
                    "--background-index"
                ],
                "bazel.lsp.command": "/usr/local/bin/starpls", // use the Starlark Language Server for Bazel projects
                "bazel.lsp.args": [
                    "server", // see https://github.com/withered-magic/starpls/issues/400#issuecomment-3095469671 - this is "what developers expect"
                    "--experimental_infer_ctx_attributes",
                    "--experimental_use_code_flow_analysis",
                    "--experimental_enable_label_completions"
                ],
                "C_Cpp.intelliSenseEngine": "disabled",
                "tasks": {
                    "version": "2.0.0",
                    "tasks": [
                        {
                            "label": "Run bazel-compile-commands",
                            "command": "bazel-compile-commands",
                            "type": "shell",
                            "isBackground": true,
                            "hide": true
                        },
                        {
                            "label": "Update compile_commands.json",
                            "command": "${command:clangd.restart}",
                            "isBackground": true,
                            "dependsOn": [
                                "Run bazel-compile-commands"
                            ],
                            "group": {
                                "kind": "build",
                                "isDefault": true
                            }
                        },
                        { // see https://bazelbuild.github.io/rules_rust/rust_analyzer.html#vscode
                            "label": "Update rust-project.json",
                            "command": "bazel",
                            "args": [
                                "run",
                                "@rules_rust//tools/rust_analyzer:gen_rust_project"
                            ],
                            "options": {
                                "cwd": "${workspaceFolder}"
                            },
                            "group": "build"
                        }
                    ]
                }
            }
        }
    }
}
